<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>Development of a High Performance Hydrological Model</title>

		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/white.css">

		<!-- Theme used for syntax highlighting of code -->
		<link rel="stylesheet" href="lib/css/monokai.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
        <section>
          <section>
            <h1> Development of a High Performance Hydrological Model </h1>
          </section>
          <section>
            <h3> Development of a High Performance Hydrological Model </h3>
            <h4> Stefano Campanella </h4>
            <p> Giacomo Bertoldi, Alberto Sartori, Stefano Cozzini </p>
            <p>
              <img class="plain" src="images/mhpc.jpg" height="100px">
              <img class="plain" src="images/hpctres.png" height="100px">
            </p>
            <p>
              <img class="plain" src="images/sissa.png" height="100px">
              <img class="plain" src="images/ictp.jpg" height="100px">
              <img class="plain" src="images/ogs.png" height="100px">
              <img class="plain" src="images/eurac.png" height="100px">
            </p>
          </section>
        </section>
        <!--
        <section>
          <h4> The Goal: Introduce myself &amp the project </h4> 
          <p> The Plan: The Five Ws and the How </p>
        </section>
        -->
        <section>
          <section>
            <h3> Who? </h3>
          </section>
          <!--
          <section>
            <ul> 
              <li> I am a graduate in theoretical physics. </li>
              <li> I worked for a small period as a developer (embedded systems) </li>
              <li> I was also a substitute physics teacher! </li>
              <li> more to the point, I long had an interest in scientific computing </li>
            </ul>
          </section>
          -->
          <section>
            <h4> Background: Theoretical Physics </h4>
            <p> I graduated with a thesis in HEP (phenomenology, hadron spectroscopy) at the University of Bari </p>
          </section>
          <section>
            <h4> Embedded System Developer </h4>
            <div class="fragment">
              <p> Embedded Systems ≈ HPC </p>
              <p> <small> knowledge of the hardware, limited resource and relevance of computational time </small> </p>
            </div>

            <div class="fragment"> 
              <p> Embedded Systems ≠ HPC </p>
              <p> <small> numerical algorithms, open-source development environment and higher level languages </small> </p>
            </div>
          </section>
          <section>
            <h4> Substitute Teacher (Phys & Math) </h4>
            <p>Funny enough, thanks to a script:</p>
            <pre> <code data-trim>
              # Sending MADs with Python! 
              for indx, s in schools.iterrows():
                  print("Sending to {}, {}".format(s.Istituto, s.Comune))
                  code = indx.lower()
                  send_email(code, "pec")
            </code> </pre>
            <small> (You can find the whole script <a href="https://gist.github.com/stefanocampanella/de2b016db21ca933c2c601568c725438">here</a>) </small>
            <!-- <script src="https://gist.github.com/stefanocampanella/de2b016db21ca933c2c601568c725438.js"></script> -->
          </section>
          <section>
            <p> More to the point, long interest in OSS and CS </p>
          </section>
        </section>
        <section>
          <section>
            <h3> What? </h3>
          </section>
          <section>
            <ul> 
              <li> I got a HPC-TRES fellowship </li>
              <li> I am now a student of the MHPC </li>
              <li> I will work on GEOtop </li>
            </ul>
          </section>
          <section>
            <h4> MHPC </h4>
            <p> a program that prepares students for careers 
            in the fast-growing field of HPC </p>
          </section>
          <section>
            <h4> GEOtop </h4>
            <p>  an integrated hydrological model that simulates 
            the heat and water budgets at and below the soil surface </p>
            <!--
            <p> GEOtop is a distributed model of the mass and energy 
            balance of the hydrological cycle<p>
            -->
          </section>
          <!--
          <section>
            <ul>
              <li> Flood and drought forecasting </li>
              <li> Water resource management </li>
              <li> Agricultural productivity forecasting </li>
              <li> Climate assessment studies </li>
            </ul>
          </section>
          -->
        </section>
        <section>
          <section>
            <h3> When? </h3>
          </section>
          <section>
            <ul> 
              <li> The MHPC lectures will last until june (approx) </li>
              <li> Then I will work on my thesis on GEOtop </li>
            </ul>
          </section>
        </section>
        <section>
          <section>
            <h3> Where? </h3>
          </section>
          <section>
            <p> Trieste (SISSA and ICTP) and Bolzano (Eurac) </p>
          </section>
          <section>
            <h4> Eurac Research </h4>
            <p> a private research institute based in Bolzano and with a strong focus on the alpine environment </p>
          </section>
        </section>
        <section>
          <section>
            <h3> Why? </h3>
          </section>
          <!--
          <section>
            <p> GEOtop, scientifically advanced, but: </p>
            <ul>
              <li> poor performance </li>
              <li> instability </li>
              <li> IO management </li>
            </ul>
          </section>
          -->
          <section>
            <p> GEOtop, scientifically advanced, but </p>
            <p> codebase &amp documentation <b> need a fix </b> </p>
            <p> <small> (not uncommon among scientific software packages) </small> </p>
          </section>
          <section>
            <h4> The Aim </h4>
            <ul>
              <li> ease further development </li>
              <li> increase usability </li>
              <li> integration with other packages </li>
              <li> {pre,post}-processing tools </li>
              <li> better performance </li>
            </ul>
          </section>
          <section>
            <h4> What HPC really means for GEOtop? </h4>
            <p class="fragment step-fade-in-then-out"> High Performance Computing </p>
            <p class="fragment step-fade-in-then-out"> High <strike>Performance</strike> Computing </p>
            <p class="fragment step-fade-in-then-out"> High Productivity Computing </p>
          </section>
          <section>
            <p> <small> So the title of this presentation should really be: </small> </p>
            <h1> Development of a High Productivity Hydrological Model </h1>
          </section>
        </section>
        <section>
          <section>
            <h3> How? </h3>
          </section>
          <section>
            <h4> Refactoring? </h4>
            <p class="fragment"> See previous talk... </p>
          </section>
          <section>
            <h4> Reengineering? </h4>
            <!--
            <ul>
              <li class="fragment"> Integration with climate models: IO management </li>
              <li class="fragment"> Simulation of larger basins: performance optimizations </li>
            </ul>
          </section>
          <section>
            <p> moreover: </p>
            -->
            <ul>
              <li class="fragment">Replacing custom linear algebra routines with BLAS/LAPACK: multithreading for free</li>
              <li class="fragment">Removing useless IO code</li>
              <li class="fragment">Modularizing the codebase</li>
            </ul>
          </section>
          <section>
            <h4> Rewriting? </h4>
            <p class="fragment"> GEOtop as library? </p> 
            <p class="fragment"> PyGEOtop? GEOtop.jl? </p>
          </section>
        </section>
        <section>
          <section>
            <h3> Julia in 3 Slides </h3>
          </section>
          <section>
            <h4> The 2 Language Problem </h3>
            <img class="plain" src="images/language_spectrum.png">
          </section>
          <section>
            <h4> Julia: Some Microbenchmarks </h4>
            <img class="plain" src="images/benchmarks.svg">
          </section>
          <section>
            <h4> JIT Compilation &amp Dynamic Multiple Dispatch </h3>
            <pre class="julia"> <code data-trim>
              methods(sin) # ex. sin(x), x = 1, 3.14, 1 + 2im, [1 2; 2 1]...
              # 12 methods for generic function "sin":
              [1] sin(x::BigFloat) in Base.MPFR at mpfr.jl:743
              [2] sin(::Missing) in Base.Math at math.jl:1072
              [3] sin(a::Complex{Float16}) in Base.Math at math.jl:1020
              [4] sin(a::Float16) in Base.Math at math.jl:1019
              [5] sin(z::Complex{T}) where T in Base at complex.jl:796
              [6] sin(x::T) where T<:Union{Float32, Float64} in Base.Math at special/trig.jl:30
              [7] sin(x::Real) in Base.Math at special/trig.jl:53
              [8] sin(A::LinearAlgebra.Hermitian{#s616,S} where S<:(AbstractArray{#s617,2} where #s617<:#s616) where #s616<:Complex) in LinearAlgebra at /build/julia/src/julia-1.2.0/usr/share/julia/stdlib/v1.2/LinearAlgebra/src/symmetric.jl:759
              [9] sin(A::Union{LinearAlgebra.Hermitian{#s617,S}, LinearAlgebra.Symmetric{#s617,S}} where S where #s617<:Real) in LinearAlgebra at /build/julia/src/julia-1.2.0/usr/share/julia/stdlib/v1.2/LinearAlgebra/src/symmetric.jl:755
              [10] sin(D::LinearAlgebra.Diagonal) in LinearAlgebra at /build/julia/src/julia-1.2.0/usr/share/julia/stdlib/v1.2/LinearAlgebra/src/diagonal.jl:468
              [11] sin(A::AbstractArray{#s617,2} where #s617<:Real) in LinearAlgebra at /build/julia/src/julia-1.2.0/usr/share/julia/stdlib/v1.2/LinearAlgebra/src/dense.jl:786
              [12] sin(A::AbstractArray{#s617,2} where #s617<:Complex) in LinearAlgebra at /build/julia/src/julia-1.2.0/usr/share/julia/stdlib/v1.2/LinearAlgebra/src/dense.jl:793
            </code> </pre>
          </section>
        </section>
        <section>
          <h3> ACKNOWLEDGMENTS </h3>
          <p> The research reported in this work will be supported 
          by OGS and CINECA under HPC-TRES program award number 2019-33 </p>
        </section>
        <section id="appendix" class="stack">
          <section>
            <h4> Julia: for a few slides more </h4>
          </section>
          <section>
            <h4> Utilities for Scientific Computing </h3>
            <pre class="julia"> <code data-trim>
            using DifferentialEquations, ParameterizedFunctions, Plots

            lorenz = @ode_def begin                 # define the system
             dx = σ * (y - x)
             dy = x * (ρ - z) - y
             dz = x * y - β*z
            end σ ρ β

            u0 = [1.0,0.0,0.0]                      # initial conditions
            tspan = (0.0,100.0)                     # timespan
            p = [10.0,28.0,8/3]                     # parameters
            prob = ODEProblem(lorenz, u0, tspan, p) # define the problem
            sol = solve(prob)                       # solve it
            plot(sol, vars = (1, 2, 3))             # plot solution 
            </code> </pre>
          </section>
          <section>
            <h4> "No Boilerplate" Philosophy </h4>
            <pre class="julia"> <code data-trim>
              function getenv(var::AbstractString)
                  val = ccall((:getenv, "libc"),
                              Cstring, (Cstring,), var)
                  if val == C_NULL
                      error("getenv: undefined variable: ", var)
                  end
                  unsafe_string(val)
              end

              getenv("SHELL") # "/bin/bash"
            </code> </pre>
          </section>
          <section>
            <h4> Parallel and Heterogeneous Computing </h4>
            <pre class="julia"> <code data-trim>
              using CuArrays, CUDAnative

              xs, ys = CuArray(rand(1024)), CuArray(rand(1024))
              zs = CuArray(zeros(1024))

              function kernel_vadd(out, a, b)
                i = (blockIdx().x-1) * blockDim().x + threadIdx().x
                out[i] = a[i] + b[i]
                return
              end

              @cuda (1, length(xs)) kernel_vadd(zs, xs, ys)
            </code> </pre>
          </section>
          <section>
            <h4> Homoiconicity </h4>
            <pre class="julia"> <code data-trim>
              macro time(ex)
                return quote
                  local t0 = time()
                  local val = $ex
                  local t1 = time()
                  println("elapsed time: ", t1-t0, " seconds")
                  val
                end
              end

              @time sin(3.14) # output: elapsed time 0.000002 seconds
            </code> </pre>
          </section>
        </section>
			</div>
		</div>

		<script src="js/reveal.js"></script>

		<script>
			// More info about config & dependencies:
			// - https://github.com/hakimel/reveal.js#configuration
			// - https://github.com/hakimel/reveal.js#dependencies
			Reveal.initialize({
				dependencies: [
					{ src: 'plugin/markdown/marked.js' },
					{ src: 'plugin/markdown/markdown.js' },
					{ src: 'plugin/notes/notes.js', async: true },
					{ src: 'plugin/highlight/highlight.js', async: true }
				]
        //// The "normal" size of the presentation, aspect ratio will be preserved
        //// when the presentation is scaled to fit different resolutions. Can be
        //// specified using percentage units.
        //width: 960,
        //height: 700,

        //// Factor of the display size that should remain empty around the content
        //margin: 0.1,

        //// Bounds for smallest/largest possible scale to apply to content
        //minScale: 0.2,
        //maxScale: 1.5
			});
		</script>
	</body>
</html>
